const url=window.location.search.substring(1),selector=document.querySelector("#genre"),grocerySelector=document.querySelector("#genre-grocery"),urlParams=new URLSearchParams(url),departmentParam=urlParams.get("department"),catagoryParam=urlParams.get("catagory"),QVCloseBtn=document.querySelector(".quickview-close-btn"),selectedImg=document.querySelector(".qv-product-main-img"),navOptions=document.querySelector(".nav-options"),groceryFlyout=document.querySelector(".grocery-flyout"),backBtn=document.querySelector(".back"),navWrapper=document.querySelector(".nav-wrapper"),cover=document.querySelector(".cover"),inputSearch=document.querySelector(".searchbar"),searchedProducts=document.querySelector(".searchedproducts"),preLoader=document.querySelector("#preloader"),genreGrocery=document.querySelector("#genre-grocery"),itemTotal=document.querySelector(".item-total"),productsDOM=document.querySelector(".products-center"),genre=document.querySelector("#genre"),sort=document.querySelector("#sort-products"),heading=document.querySelector("#products-heading"),quickViewDOM=document.querySelector(".product-quick-view-wrapper"),QVProductDOM=document.querySelector(".quickview-product"),groceryFlyoutBtn=document.querySelector("#grocery"),cartItems=document.querySelector(".cart-items"),cartBtnDOM=document.querySelector(".cart-btn-wrapper");class Products{async getProducts(){try{let result=await fetch("products.json"),data,products=(await result.json()).items;return products=products.map(item=>{const{title:title,description:description,minimage:minimage,type:type,price:price}=item.fields,{id:id}=item.sys,image=item.fields.image.fields.file.url;return{title:title,price:price,id:id,image:image,minimage:minimage,type:type,description:description}}),products}catch(error){console.log(error)}}}let cart=[],buttonsDOM=[];class UI{async displayProducts(products){if("title-asc"==sort.value){function alphabeticSort(x,y){return x.title<y.title?-1:x.title>y.title?1:0}products.sort(alphabeticSort)}else if("title-dsc"==sort.value){function alphabeticSort(x,y){return x.title<y.title?-1:x.title>y.title?1:0}products.sort(alphabeticSort),products.reverse()}else if("price-dsc"==sort.value){function alphabeticSort(x,y){return x.price<y.price?-1:x.price>y.price?1:0}products.sort(alphabeticSort),products.reverse()}else if("price-asc"==sort.value){function alphabeticSort(x,y){return x.price<y.price?-1:x.price>y.price?1:0}products.sort(alphabeticSort)}let genreValues=[];genreValues.push(genre.value),"grocery"==genre.value&&-1===genreValues.indexOf(genreGrocery.value)&&genreValues.push(genreGrocery.value);let result="";products.forEach(product=>{var a=product.type,b=genreValues.toString().replace(","," ");function check(genreVal){return genreVal===b}a.filter(check)==b&&(result+=`\n            \x3c!-- single product --\x3e\n            <article class="product ${product.type}" name=${product.type}>\n            <div class="img-container">\n                    <img \n                    src=${product.minimage}\n                    data-src=${product.image[0]}\n                    alt="product"\n                    class="product-img"> <i class="fas fa-heart wishlist-btn"></i>\n                    <button class="quick-view-btn" \n                    data-id=${product.id}>\n                        Quick View\n                    </button>\n                </div>\n                <h3>${product.title}</h3>\n                <h4>RS: ${product.price}</h4>\n            </article>\n            \x3c!-- end of single product --\x3e\n            `)}),productsDOM.innerHTML=result,this.changeHeading(),this.observing()}observing(){const images=document.querySelectorAll("[data-src]");function preloadImage(img){const src=img.getAttribute("data-src");if(src){var bigImage=document.createElement("img");bigImage.onload=function(){img.src=this.src},bigImage.src=src}}const imgOptions={},imgObserver=new IntersectionObserver((entries,imgObserver)=>{entries.forEach(entry=>{entry.isIntersecting&&(preloadImage(entry.target),imgObserver.unobserve(entry.target))})},imgOptions);images.forEach(image=>{imgObserver.observe(image)})}changeHeading(){heading.innerHTML="",genre.value===genreGrocery.value?heading.innerHTML+=genre.value:heading.innerHTML+=genre.value+" &#8250; "+genreGrocery.value}quickViewButtons(products){const buttons=[...document.querySelectorAll(".quick-view-btn")];buttonsDOM=buttons,buttons.forEach(button=>{let id=button.dataset.id;button.addEventListener("click",()=>{quickViewDOM.classList.add("show-qv"),QVCloseBtn.classList.remove("hide"),document.querySelector(".cover").style.display="block";let product=products.find(product=>product.id===id);this.addQVItem(product),this.quickViewOpened(product)})})}quickViewOpened(Product){QVCloseBtn.addEventListener("click",()=>{quickViewDOM.classList.contains("show-qv")&&(QVCloseBtn.classList.add("hide"),quickViewDOM.classList.remove("show-qv"),document.querySelector(".cover").style.display="none")}),cover.addEventListener("click",()=>{quickViewDOM.classList.contains("show-qv")&&(QVCloseBtn.classList.add("hide"),quickViewDOM.classList.remove("show-qv"),document.querySelector(".cover").style.display="none")});const QVPImgs=document.querySelectorAll(".qv-product-img");QVPImgs.forEach(img=>{img.addEventListener("click",img=>{selectedImg.src=img.target.src,QVPImgs.forEach(img=>{img.classList.remove("selected")}),img.target.classList.add("selected")})})}addQVItem(product){const QVPTitle=document.querySelector(".qv-product-title"),QVPPath=document.querySelector(".qv-product-path"),QVPId=document.querySelector(".qv-product-id"),QVPPrice=document.querySelector(".qv-product-price"),QVPImgs=document.querySelector(".product-images-wrapper"),QVPQtyDOM=document.querySelector(".qv-product-quantity"),QVPDescriptionDOM=document.querySelector(".qvp-description");let imgs="";Array.from(product.image).forEach((img,index)=>{imgs+=`<img class="qv-product-img" src="${product.image[index]}" alt="">`});let cartbtn=`<button class="qvcartbtn" data-id=${product.id}>\n                    add to cart\n                </button>`;product.amount="1";let productQty=`<i class="fas fa-plus" data-id="${product.id}" aria-hidden="true"></i>\n                        <span class="item-amount">${product.amount}</span>\n                        <i class="fas fa-minus" data-id="${product.id}" aria-hidden="true"></i>`,QVPDescription=product.description;QVPTitle.innerHTML=product.title,QVPPath.innerHTML=product.type[1].replace(" ","&#8250;"),QVPId.innerHTML="<span>Id: </span>"+product.id,QVPPrice.innerHTML="<span>RS: </span>"+product.price,QVPImgs.innerHTML=imgs,QVPQtyDOM.innerHTML=productQty,QVPDescriptionDOM.innerHTML=QVPDescription,selectedImg.src=product.image[0],cartBtnDOM.innerHTML=cartbtn,QVPQtyDOM.addEventListener("click",()=>{if(event.target.classList.contains("fa-plus")){if(product.amount<20){let addAmount=event.target;product.amount=+product.amount+1,addAmount.nextElementSibling.innerText=product.amount}}else if(event.target.classList.contains("fa-minus")){let lowerAmount=event.target;product.amount>1&&(product.amount=+product.amount-1,lowerAmount.previousElementSibling.innerText=product.amount)}});const qvcartbtn=document.querySelector(".qvcartbtn");let inCart;cart.find(item=>item.id===product.id)&&(qvcartbtn.innerText="In Cart",qvcartbtn.disabled=!0),qvcartbtn.addEventListener("click",event=>{event.target.innerText="In Cart",event.target.disabled=!0;let cartItem={...product};cart=[...cart,cartItem],Storage.saveCart(cart),this.setCartValues(cart)})}setCartValues(cart){let itemsTotal=0;cart.map(item=>{itemsTotal+=+item.amount}),cartItems.innerText=itemsTotal}setupAPP(){cart=Storage.getCart(),this.setCartValues(cart)}parseToSearch(products){inputSearch.addEventListener("keyup",()=>{let result="";var b=inputSearch.value.toUpperCase().split(" ");products.forEach(product=>{var a=product.title.toUpperCase();""==inputSearch.value?searchedProducts.style.display="none":b.every(item=>a.includes(item))&&(searchedProducts.style.display="block",result+=`<li data-id=${product.id} class="searchedproduct"><img data-id=${product.id} src=${product.minimage}><h1 data-id=${product.id} >${product.title}</h1></li>`)}),searchedProducts.innerHTML=result}),inputSearch.addEventListener("focus",()=>{searchedProducts.style.display="block"}),searchedProducts.addEventListener("click",()=>{let id=event.target.dataset.id;QVCloseBtn.classList.remove("hide"),searchedProducts.style.display="none",quickViewDOM.classList.add("show-qv");let product=products.find(item=>item.id===id);this.quickViewOpened(product),this.addQVItem(product)})}}class Storage{static saveCart(cart){localStorage.setItem("cart",JSON.stringify(cart))}static getCart(){return localStorage.getItem("cart")?JSON.parse(localStorage.getItem("cart")):[]}}document.addEventListener("DOMContentLoaded",app=()=>{const ui=new UI,products=new Products;ui.setupAPP(),products.getProducts().then(products=>{ui.displayProducts(products),ui.parseToSearch(products),ui.quickViewButtons(products)})});